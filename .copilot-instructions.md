# Copilot Instructions for OneApp2 Jira Project

## Jira Custom Field Mappings

Based on the Jira changelog analysis, the following custom field mappings are used in this project:

- `customfield_10331` = **Story Points** (labeled as "Story point estimate" in Jira)
- `customfield_10127` = **Sprint Field** (used for sprint assignments and history)

## Sprint History and Carryover Logic

- Sprint history is extracted from `customfield_10127` changelog entries
- Tasks are classified as "carryover" if their first sprint (oldest in sprintHistory) is different from the current sprint
- The carryover classification logic: `firstSprint !== currentSprintId`

## API Structure

- Use JQL query `sprint = ${sprintId}` to fetch tasks for a specific sprint
- Always include `expand=changelog` to get sprint history from changelog
- Story points metrics should always reference `customfield_10331`

## Key Components

- **Edge/Netlify Functions**: Handle Jira API calls and data transformation
- **Middleware**: Adds carryover classification (`firstSprint`, `isCarryover` fields)
- **Dashboard**: Displays tasks separated by new vs carryover classification

## Architecture & Implementation Details

### Netlify Functions
- **netlify/functions/jira-proxy.ts**: Main function for fetching Jira issues, projects, and sprints
- **netlify/functions/jira-users.ts**: Fetches users from Jira API using `/rest/api/3/users/search`
- Authentication via environment variables or shared global storage (`global.jiraConfigStorage`)
- Edge functions were removed due to local dev loading issues - use regular Netlify functions

### Context & State Management
- **JiraContext.tsx**: Central context provider with middleware for carryover classification
- KPI configuration state management with localStorage persistence
- User activation system with single `active` field (not `isActive`)
- Shared global storage for credential sharing between functions

### KPI System
- **Configurable Weights**: Story Points (20%), Tasks (20%), Complexity (20%), Rework (30%), Delays (10%)
- **Dynamic Targets**: Sprint Quality (85%), Historical Rework Rate (10%), Perfect Work Limit (100%)
- **Calculation**: Uses corrected formulas with proper weight handling as percentages
- **Logging**: Detailed console logging for KPI calculations and cache management

### User Management
- **UsersPage.tsx**: Complete user management with role assignment and activation toggles
- **Single Source of Truth**: JiraContext manages user activation exclusively
- **Persistence**: localStorage for user data and activation states
- **Field Standardization**: Use `active` field only (not `isActive`)

### Data Flow & Caching
- **Cache Strategy**: Projects, sprints, tasks, and users cached in context state
- **Force Refresh**: ForceJiraUpdateButton refreshes all data from Jira
- **KPI Cache**: Sprint-specific KPI caching with recalculation triggers
- **Middleware Processing**: Carryover classification and user activation status

### Configuration Files
- **netlify.toml**: Redirects routing API calls to appropriate Netlify functions
- **No Edge Functions**: All edge function configurations removed
- **Environment**: Uses Netlify environment variables for Jira authentication

## Development Guidelines

### Code Standards
- Remove all test code, test buttons, and test data files
- Use minimal code implementations - avoid verbose solutions
- Maintain proper TypeScript typing throughout
- Follow existing architecture patterns

### Data Handling
- Always use middleware for data transformation
- Maintain cache consistency across components
- Use localStorage for persistent configuration
- Handle authentication through shared global storage

### KPI Implementation
- Use dynamic targets from configuration state
- Implement proper weight validation (must sum to 100%)
- Include detailed logging for debugging
- Clear cache when configuration changes

### User System
- Use single `active` field for user activation
- JiraContext is the single source of truth
- Persist user data in localStorage
- Handle role assignment through user management page